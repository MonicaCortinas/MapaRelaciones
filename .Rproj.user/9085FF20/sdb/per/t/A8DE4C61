{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Mapa para relaciones OTRI\"\n---\n\nEste mapa se ha elaborado uniendo los datos proporcionados por la OTRI. Se ha utilizado el nombre de la empresa, el NIF, el tipo de relación (acuerdo marco, servicios, asesoría, formación o I+D) y los ingresos.\n\nA partir de los datos disponibles, se ha completado manualmente el código <a href=\"https://www.cnae.com.es/lista-actividades.php\" target=\"_blank\">CNAE</a>. En muchos casos el código CNAE es una aproximación, habría que depurar bien la base y tratar de completarla con datos de facturación o trabajadores de las entidades.\n\nCon este código, se ha realizado una agrupación por sectores, realizada ad-hoc. \n\n```{r cnae, message=FALSE, warning=FALSE}\nlibrary(readr)\n\n# compute new cnae (cs$CNAE, fus$CNAE, otri$CNAE)\n\ncnae2009 <- read_csv(\"data/cnae2009.csv\", \n                    col_types = cols(CODINTEGR = col_skip(), \n                     COD_CNAE2009 = col_character(), X4 = col_skip(), \n                     X5 = col_skip()))\n\n#newcodes\n# cuatro cifras\n\ncnae4d<- cnae2009[which(nchar(cnae2009$COD_CNAE2009)==4),]\n\ncnae4d$grupocnae <- \n      ifelse (cnae4d$COD_CNAE2009 < 1000,\n            paste(\"0\",cnae4d$COD_CNAE2009, sep=\"\"),\n      (ifelse((cnae4d$COD_CNAE2009 >= 1000) & (cnae4d$COD_CNAE2009 < 1200), \n            paste(\"1\",cnae4d$COD_CNAE2009, sep=\"\"),\n      ifelse((cnae4d$COD_CNAE2009 >= 1200) & (cnae4d$COD_CNAE2009 < 2900), \n            paste(\"3\",cnae4d$COD_CNAE2009, sep=\"\"),\n      ifelse((cnae4d$COD_CNAE2009 >= 2900) & (cnae4d$COD_CNAE2009 < 3000), \n            paste(\"2\",cnae4d$COD_CNAE2009, sep=\"\"),\n      ifelse((cnae4d$COD_CNAE2009 >= 3000) & (cnae4d$COD_CNAE2009 < 3500), \n            paste(\"3\",cnae4d$COD_CNAE2009, sep=\"\"),\n      ifelse((cnae4d$COD_CNAE2009 >= 4110) & (cnae4d$COD_CNAE2009 < 4400), \n            paste(\"3\",cnae4d$COD_CNAE2009, sep=\"\"),\n      ifelse((cnae4d$COD_CNAE2009 >= 3500) & (cnae4d$COD_CNAE2009 < 4000), \n            paste(\"4\",cnae4d$COD_CNAE2009, sep=\"\"), \n      ifelse((cnae4d$COD_CNAE2009 >= 4500) & (cnae4d$COD_CNAE2009 <= 5630), \n            paste(\"5\",cnae4d$COD_CNAE2009, sep=\"\"),\n      ifelse((cnae4d$COD_CNAE2009 >= 5800) & (cnae4d$COD_CNAE2009 <= 8299), \n            paste(\"6\",cnae4d$COD_CNAE2009, sep=\"\"),       \n      ifelse((cnae4d$COD_CNAE2009 >= 9000) & (cnae4d$COD_CNAE2009 < 9330), \n            paste(\"6\",cnae4d$COD_CNAE2009, sep=\"\"), \n      ifelse((cnae4d$COD_CNAE2009 >= 8400) & (cnae4d$COD_CNAE2009 <= 8899), \n            paste(\"7\",cnae4d$COD_CNAE2009, sep=\"\"),       \n      ifelse((cnae4d$COD_CNAE2009 >=9400), \n            paste(\"7\",cnae4d$COD_CNAE2009, sep=\"\"),       0\n                    )))))))))))))\n\ncnae4d$nombregrupo <- \n      ifelse (cnae4d$COD_CNAE2009 < 1000,\n            paste(\"Sector primario y extracción\"),\n      ifelse((cnae4d$COD_CNAE2009 >= 1000) & (cnae4d$COD_CNAE2009 < 1200), \n            paste(\"Sector Industria-Alimentación\"),\n      ifelse((cnae4d$COD_CNAE2009 >= 1200) & (cnae4d$COD_CNAE2009 < 2900), \n            paste(\"Otra Industria y construcción\"),\n      ifelse((cnae4d$COD_CNAE2009 >= 2900) & (cnae4d$COD_CNAE2009 < 3000), \n            paste(\"Sector Industria_Motor\"),\n      ifelse((cnae4d$COD_CNAE2009 >= 3000) & (cnae4d$COD_CNAE2009 < 3500), \n            paste(\"Otra Industria y construcción\"),\n      ifelse((cnae4d$COD_CNAE2009 >= 4110) & (cnae4d$COD_CNAE2009 <= 4400), \n            paste(\"Otra Industria y construcción\"),\n      ifelse((cnae4d$COD_CNAE2009 >= 3500) & (cnae4d$COD_CNAE2009 <= 4000), \n            paste(\"Suministros y Energía\"), \n      ifelse((cnae4d$COD_CNAE2009 >= 4500) & (cnae4d$COD_CNAE2009 <= 5630), \n            paste(\"Comercio, Transporte, Hostelería\"),\n      ifelse((cnae4d$COD_CNAE2009 >= 5800) & (cnae4d$COD_CNAE2009 <= 8299), \n            paste(\"Servicios: Información, Artístico, Informática, Consultoría, Financieros\"),       \n      ifelse((cnae4d$COD_CNAE2009 >= 9000) & (cnae4d$COD_CNAE2009 < 9330), \n            paste(\"Servicios: Información, Artístico, Informática, Consultoría, Financieros\"), \n      ifelse((cnae4d$COD_CNAE2009 >= 8400) & (cnae4d$COD_CNAE2009 <= 8899), \n            paste(\"Admon. Pública, Educación, Asociaciones, Extraterrit\"),       \n      ifelse((cnae4d$COD_CNAE2009 >=9400), \n            paste(\"Admon. Pública, Educación, Asociaciones, Extraterrit\"), 0\n            ))))))))))))\nrm(cnae2009)\n\n# Mapa OTRI\nlibrary(dplyr)\nlibrary(tidyverse)\notri <- read_csv(\"data/Otriconcnae.csv\", \n                 locale = locale(asciify = TRUE), na = \"empty\")\n\n# Hay algunos códigos cnae de 3 cifras incorrectos\n# Los corregimos:\ncnae3<- otri[which(nchar(otri$CNAE)==3),] # Localiza códigos de 3 cifras\notri[which(otri$CNAE==\"121\"),6]<-\"0121\"\nrm(cnae3)\nnames(otri)<-gsub(\" \", \"\", names(otri)) # Quitar espacios en blanco\nlength(table(otri$CIF)) #Comprobamos que cada fila es una empresa: no lo es\n\ningresos <- aggregate(formula = otri$ImportesinIVA ~ otri$CIF+otri$Tipocontrato, FUN = sum)\nnombre <- aggregate(formula = otri$Nombreentidad ~ otri$CIF+otri$Tipocontrato, FUN = last)\ncaracter <- aggregate(formula = otri$Caracter ~ otri$CIF+otri$Tipocontrato, FUN = last)\ncnae <- aggregate(formula = otri$CNAE ~ otri$CIF+otri$Tipocontrato, FUN = last)\nambito <- aggregate(formula = otri$Ambito ~ otri$CIF+otri$Tipocontrato, FUN = last)\n\notri_empresa <- cbind.data.frame(nombre[,1:3], cnae[,3], ingresos[,3], \n                                 caracter[,3],ambito[,3], stringsAsFactors = FALSE )\nnames(otri_empresa)<- c(\"cif\", \"tipo\", \"nombre\", \"cnae\", \"ingresos\", \"caracter\", \"ambito\")\n\nrm(ingresos, nombre, caracter, cnae, ambito)\n\n\n# Completa los códigos\nfor (i in 1:length(otri_empresa$cif)) {\n      otri_empresa[i, 8]<- cnae4d[grep(as.numeric(otri_empresa[i,4]),cnae4d$grupocnae),3]\n}\n\n\nfor (i in 1:length(otri_empresa$cif)) {\n      otri_empresa[i, 9]<- cnae4d[grep(as.numeric(otri_empresa[i,4]),cnae4d$grupocnae),4]\n}\n\notri_empresa$grupocnae <- as.numeric(otri_empresa$grupocnae)\n\n# Variable X: grupocnae\n# Variable Y: ingresos\n# facets: tipo\n# size: ambito\n# https://plot.ly/r/getting-started/\n```\n\nSe ha realizado un gráfico de dispersión con tres indicadores:\n\n- Eje horizontal: es el sector con esta recodificación\n- Eje vertical: son los ingresos que proporciona cada relación\n- Eje z: El tamaño del círculo se corresponde con el número de contactos\n\nSe incluyen otros datos como el nombre y el tipo de relación. La herramienta permite hacer zoom sobre el mapa seleccionando cualquier cuadrante. \"Reset zoom\" devuelve el mapa a su tamaño original.\n\nTambién se puede seleccionar los tipos de relación  pulsando sobre la leyenda del mapa.\n\n```{r plotOTRI, message=FALSE, warning=FALSE}\nlibrary(devtools)\n# devtools::install_github(\"ropensci/plotly\")\nlibrary(plotly)\nlibrary(\"ggsci\")\nSys.setenv(\"plotly_username\"=\"mcortinas\")\nSys.setenv(\"plotly_api_key\"=\"yJb8VBxhRqDRAOesNWRT\")\n\np <- ggplot(otri_empresa, aes(x = grupocnae, y = ingresos)) +\n      geom_point(aes(size = ingresos, color=tipo, alpha=3/4, text = paste(\"Nombre:\", otri_empresa$nombre))) +\n      labs( title=\"Mapa de Relaciones OTRI\" , subtitle = NULL) +\n      scale_y_continuous(name=\"Ingresos\",breaks=c(0, 5000,10000,20000,50000, 100000, 150000),\n                         labels=paste(c(0, 5000,10000,20000,50000, 120000, 150000),\"\\U20AC\", sep=\"\"))+\n      scale_x_continuous(name=\"Sector\", limits=c(0,80000), breaks=c(500,12000,22000,32000, 43000,54000,66000,78000),\n                         labels=c(\"Sector primario y extracción\", \"Sector Industria-Alimentación\", \"Sector Industria_Motor\",\n                                  \"Otra Industria y construcción\", \"Suministros y Energía\", \"Comercio, Transporte, Hostelería\",\n                                  \"Servicios: Banca, Informática, Consultoría...\",\n                                  \"Admon. Pública, Educación...\"))+\n      scale_color_lancet()+\n      theme_bw()\n\ngg <- ggplotly(p)\nl <- list(\n      font = list(\n            family = \"sans-serif\",\n            size = 16,\n            color = \"#000\"),\n      x = 0.05, \n      y = 0.95, \n      orientation = 'h',\n      bordercolor = \"#E2E2E2\",\n      borderwidth = 2)\n\nl2 <- list(source = \"http://www.unavarra.es/css/bitmaps/upna30-iberus.png?raw=true\",\n           xref = \"x\",\n           yref = \"y\",\n           x = 0.9,\n           y = 3.1,\n           sizex = 2,\n           sizey = 2,\n           sizing = \"stretch\",\n           opacity = 0.4,\n           layer = \"below\"\n)\nlayout(gg, legend = l, images = l2)\n```\n\n\n\n<a href=\"maps/mapaotri.html\" target=\"_blank\">Acceder en pantalla completa al mapa</a>",
    "created" : 1524324439302.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "193954259",
    "id" : "A8DE4C61",
    "lastKnownWriteTime" : 1524326857,
    "last_content_update" : 1524326857103,
    "path" : "D:/Dropbox/0_LatexyGit/mapaWebPaga/otri.Rmd",
    "project_path" : "otri.Rmd",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}